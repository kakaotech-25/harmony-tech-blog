---
title: ìŠ¤í”„ë§ ë¡œì»¬ ìºì‹œì™€ TTL ì„ êµ¬í˜„í•œ ì™¸ë¶€ ì„œë¹™ API ìš”ì²­ ìµœì í™”
date: "2024-09-29"
series: backend trouble shooting
writer: í•˜ì˜¨
tags:
  - ìºì‹œ
  - ìŠ¤í”„ë§
  - í•˜ì˜¨
previewImage: lion.png
---

## ì™¸ë¶€ API ìš”ì²­ì´ ë§¤ìš° ëŠë¦° ë¬¸ì œìƒí™©

ìš°ë¦¬ í•˜ëª¨ë‹ˆ íŒ€ì´ ê°œë°œì¤‘ì¸ ëª¨í–‰ ì„œë¹„ìŠ¤ëŠ” ì—¬í–‰ì§€ í•˜ë‚˜ë¥¼ í´ë¦­í–ˆì„ ë•Œ ê·¸ì™€ ì„±í–¥ì´ ë¹„ìŠ·í•œ ì—¬í–‰ì§€ ë¦¬ìŠ¤íŠ¸ 10ê°œë¥¼ í•¨ê»˜ ì²œí•˜ê³  ìˆë‹¤. ë¹„ìŠ·í•œ ì„±í–¥ì˜ ì—¬í–‰ì§€ë¥¼ ì¶”ì²œë°›ê¸° ìœ„í•´ AI ëª¨ë¸ì„ ì„œë¹™í•  FastAPI ì„œë²„ì—ê²Œ ìš”ì²­ì„ ì „ì†¡í•˜ê³ , ê·¸ì™€ ë¹„ìŠ·í•œ ì—¬í–‰ì§€ë¥¼ ì‘ë‹µë°›ê³  ìˆë‹¤. ê·¸ë¦¬ê³  ìŠ¤í”„ë§ë¶€íŠ¸ ì„œë²„ì—ì„  ì‘ë‹µë°›ì€ ì—¬í–‰ì§€ ë¦¬ìŠ¤íŠ¸ë¥¼ í˜„ì¬ ì—¬í–‰ì§€ì™€ ë™ì¼í•œ ìƒí™œì •ë³´ë¥¼ ë³´ìœ í•œ ì—¬í–‰ì§€ë“¤ë¡œë§Œ í•„í„°ë§í•˜ê³  ìˆë‹¤. **ì‰½ê²Œë§í•´, AI ì„œë²„ë¡œë¶€í„° ì‘ë‹µë°›ì€ ê²°ê³¼ë¥¼ ê³„ì† í•„í„°ë§í•˜ì—¬ ì—¬í–‰ì§€ 10ê°œê°€ ì±„ì›Œì§ˆ ë•Œ ê¹Œì§€ ìš”ì²­ì„ ê³„ì† ì „ì†¡í•˜ëŠ” êµ¬ì¡°**ì´ë‹¤. ì´ëŸ° í”Œë¡œìš°ë¥¼ í†µí•´ ì‚¬ìš©ìê°€ ì—¬í–‰í•˜ê¸°ì— ì¢‹ì„ ìµœì ì˜ ì—¬í–‰ì§€ë“¤ì„ ì¶”ì²œí•˜ëŠ” ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ê³  ìˆë‹¤.

![alt text](image-1.png)


ì •ë§ ì¢‹ì€ ê¸°ëŠ¥ì´ì§€ë§Œ, ë§ë§Œ ë“¤ì–´ë„ ì„±ëŠ¥ìƒì˜ ì´ìŠˆê°€ ë°œìƒí•  ê²ƒ ê°™ë‹¤. ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸í•œ ê²°ê³¼ AI ëª¨ë¸ ì„œë¹™ ì„œë²„ì— í•œë²ˆ API ìš”ì²­ì„ ë³´ë‚´ê³  ì‘ë‹µ ë°›ê¸°ê¹Œì§€ **ì•½ 250ms ê°€ëŸ‰ì˜ ì‹œê°„ì´ ì†Œìš”**ëœë‹¤. ê·¸ëŸ°ë° ë§Œì•½ AI ì„œë²„ì—ê²Œ ìš”ì²­ì„ ë³´ë‚´ëŠ” íšŸìˆ˜ê°€ ë§ì•„ì§„ë‹¤ë©´ ì–´ë–»ê²Œë ê¹Œ? 4ë²ˆì˜ ìš”ì²­ì„ AI ì„œë²„ì—ê²Œ ì „ì†¡í•œë‹¤ë©´, **ë¹„ìŠ·í•œ ì„±í–¥ì˜ ì—¬í–‰ì§€ë¥¼ ì¡°íšŒí•˜ëŠ”ë°ë§Œ ì•½ 1000ms ê°€ ë„˜ëŠ” ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ê²ƒì´ë‹¤.** ì‚¬ìš©ì ê²½í—˜ ì¸¡ë©´ì—ì„œ ì¢‹ì§€ ì•ŠëŠ” ìƒí™©ì´ë‹¤.

ì´ëŸ¬í•œ ì™¸ë¶€ API ìš”ì²­ìœ¼ë¡œ ì¸í•´ ì„±ëŠ¥ ì´ìŠˆë¥¼ ì–´ë–»ê²Œ ê°œì„ í• ì§€ ê³ ë¯¼ì´ ë§ì•˜ë‹¤. ì™¸ë¶€ API ìš”ì²­ì€ ë°ì´í„°ë² ì´ìŠ¤ì²˜ëŸ¼ ì¸ë±ì‹±ì„ í†µí•´ ì„±ëŠ¥ ê°œì„ ì´ ê°€ëŠ¥í•œ ìš”ì†Œë„ ì•„ë‹ˆë‹¤. ê³ ë¯¼ ëì— ìš°ë¦¬ íŒ€ì€ ìºì‹±ì„ ë„ì…í•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤. **ì™¸ë¶€ API ìš”ì²­ ë‚´ì—­ì„ ìŠ¤í”„ë§ ë¡œì»¬ ìºì‹œë¡œ ìºì‹±í•˜ê³ , ìºì‹±ëœ ë¹„ìŠ·í•œ ì„±í–¥ì˜ ì—¬í–‰ì§€ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ì¡°íšŒí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì„±ëŠ¥ ê°œì„ ì„ ê³ ì•ˆí–ˆë‹¤.**

## ìºì‹±ëœ ì´ì „ ë²„ì „ì˜ ë°ì´í„°ë§Œ ì½ì–´ì˜¤ëŠ” ë¬¸ì œ 

ìŠ¤í”„ë§ì€ ìì£¼ ì‚¬ìš©ë˜ë©´ì„œ í˜¸ì¶œì´ ë¹ˆë²ˆí•œ ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ì‰½ê²Œ ìºì‹±í•  ìˆ˜ ìˆë„ë¡ AOP ë¥¼ í†µí•´ `@Cacheable` ì„ ì œê³µí•œë‹¤. AOP ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë‚´ë¶€ êµ¬í˜„ì´ ì˜í–¥ì„ ì£¼ì§€ ì•Šê³ , íŠ¹ì • ìºì‹œ êµ¬í˜„ì²´(ê¸°ìˆ ) ì— ì¢…ì†ë˜ì§€ ì•Šë„ë¡ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤. 

ìŠ¤í”„ë§ì€ ë³„ë‹¤ë¥¸ ì„¤ì •ì´ ì—†ë‹¤ë©´ ê¸°ë³¸ ìºì‹œ êµ¬í˜„ì²´ë¡œ `ConcurrentMapCache` ë¥¼ íƒí•˜ê³  ìˆë‹¤. ì´ ìºì‹œ êµ¬í˜„ì²´ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `ConcurrentHashMap` ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê°„ë‹¨í•œ êµ¬í˜„ì²´ì´ë‹¤. ìš°ë¦¬ íŒ€ì˜ ê²½ìš°ë„ ì´ˆê¸°ì—” íŠ¹ë³„í•œ ìºì‹œ êµ¬í˜„ì²´ë¥¼ ë„ì…í•´ì•¼ í•  ì´ìœ ê°€ ì—†ì—ˆê¸° ë•Œë¬¸ì—, ì•„ë˜ì²˜ëŸ¼ ê°„ë‹¨íˆ `@Cacheable` ì„ ëª…ì‹œí•˜ê³  ê¸°ë³¸ ìºì‹œ êµ¬í˜„ì²´ì¸  `ConcurrentMapCache` ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•˜ê³  ìˆì—ˆë‹¤.

~~~java
@Cacheable(value = "SIMILAR_TRIP_CACHE", key = "#contentId+#page")
@Override
public FindSimilarTripWithContentIdResponses findSimilarTrips(final long contentId, final long page) {
    return requestSimilarTrips(new SimilarTripRequests(contentId, page));
}
~~~

### ConcurrentMapCache ì€ TTL ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤

í•˜ì§€ë§Œ ë¬¸ì œê°€ ìˆì—ˆë‹¤. AI ì„œë²„ë¡œë¶€í„° ì‘ë‹µë°›ëŠ” ë¹„ìŠ·í•œ ì„±í–¥ì˜ ì—¬í–‰ì§€ëŠ” í•­ìƒ ê±°ì˜ ë™ì¼í•œ ë°ì´í„°ë¥¼ ì‘ë‹µë°›ëŠ”ë‹¤ëŠ” íŠ¹ì§•ì´ ìˆì—ˆì§€ë§Œ, ë‚®ì€ ì˜¤ì°¨ìœ¨ë¡œ ì¸í•´ ì •ë§ ë“œë¬¼ê²Œ ê°„í˜¹ ë‹¤ë¥¸ ì„±í–¥ì˜ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” ê²½ìš°ë„ ì¡´ì¬í—€ë‹¤. ì¦‰, ë¹„ìŠ·í•œ ì„±í–¥ì´ ì•„ë‹Œ ë‹¤ë¥¸ ì„±í–¥ì˜ ì¼ë¶€ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ê³  ìºì‹±í•˜ê³  ìˆë‹¤. ì´ ë–„ë¬¸ì— ìºì‹œì—ì„œ ë‹¤ë¥¸ ì„±í–¥ì˜ ë°ì´í„°ë¥¼ ê³„ì† ì¡°íšŒí•˜ê²Œ ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤. ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **ìºì‹±ëœ ë°ì´í„°ëŠ” ìºì‹œì—ì„œ ì˜êµ¬ ì €ì¥ë˜ì§€ ì•Šê³  ì¼ì • ì‹œê°„ì´ ì§€ë‚¬ì„ ë•Œ ë§Œë£Œë˜ì–´ ì œê±°ë˜ëŠ” ê¸°ëŠ¥ì´ í•„ìš”í–ˆë‹¤.**  

í•˜ì§€ë§Œ `ConcurrentMapCache` ëŠ” **TTL(Time-To-Live) ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤.** ë”°ë¼ì„œ ìºì‹±ëœ ë°ì´í„°ì˜ ë§Œë£Œ ê¸°í•œì„ ì„¤ì •í•  ìˆ˜ ì—†ê³ , í•œë²ˆ ìºì‹±ëœ ë°ì´í„°ë¥¼ ì§€ìš°ê¸° ìœ„í•´ ìŠ¤ìºì¥´ë§ì„ ëŒë ¤ì„œ ëª¨ë“  ë°ì´í„°ë¥¼ ì¼ê´„ ì‚­ì œí•´ì•¼í•œë‹¤. ê·¸ëŸ°ë° ìš°ë¦¬ê°€ ìºì‹œí•˜ë ¤ê³  í•˜ëŠ” ë°ì´í„°ëŠ” í˜„ì¬ ì—¬í–‰ì§€ì™€ ë¹„ìŠ·í•œ ì„±í–¥ì˜ ì—¬í–‰ì§€ ë¦¬ìŠ¤íŠ¸ì´ë‹¤. 

![alt text](image-3.png)

ë§Œì•½ ìºì‹œ ë©”ëª¨ë¦¬ë‚´ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì¼ê´„ ì‚­ì œí•´ë²„ë¦°ë‹¤ë©´, ìºì‹œ ë©”ëª¨ë¦¬ì— ì˜¬ë ¤ë†“ê³  ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ê°€ ë¶ˆí•„ìš”í•˜ê²Œ ìºì‹œ ë©”ëª¨ë¦¬ì—ì„œ ì œê±°ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤. **ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ëŠ” ìºì‹œì—ì„œ ì œê±°ë˜ì§€ ì•Šê³  Hit ë˜ì–´ì•¼í•œë‹¤. ê·¸ë˜ì•¼ Cache Hit ë¹„ìœ¨ì´ ë†’ì•„ì§€ê³ , ì„±ëŠ¥ì´ ì¢‹ì•„ì§ˆ ê²ƒì´ë‹¤.**  ë‹¤ì‹œë§í•´, ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ê°€ ë¶ˆí•„ìš”í•˜ê²Œ ìºì‹œì—ì„œ ì œê±°ë˜ë©´ Miss Rate ì´ ë†’ì•„ì§€ë¯€ë¡œ ì„±ëŠ¥ ì €í•˜ ì´ìŠˆê°€ ë°œìƒí•œë‹¤.

ê²Œë‹¤ê°€ ì¼ê´„ì ìœ¼ë¡œ ìºì‹œ ë©”ëª¨ë¦¬ë‚´ ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ì›Œë²„ë¦°ë‹¤ë©´, ë°©ê¸ˆì „ì— ë§‰ ìºì‹±ëœ ë°ì´í„°ë“¤ë„ ì œê±°ëŒ€ìƒì´ ëœë‹¤. ì´ëŸ¬í•œ ì´ìœ ë“¤ë¡œ **ìºì‹±ëœ ë°ì´í„°ë“¤ì€ ì¼ê´„ ì œê±°ë°©ì‹ì´ ì•„ë‹ˆë¼, ê° ë°ì´í„°ê°€ ê°œë³„ì ì¸ ë§Œë£Œ ê¸°ê°„ì„ ê°€ì ¸ì•¼í•œë‹¤.** 

ê° ë°ì´í„°ì— ëŒ€í•œ ê°œë³„ì ì¸ TTL ê¸°ëŠ¥ì„ ì§€ì›í•˜ê¸° ìœ„í•´ `EnCache`, `CaffinCache`, `Redis` ì™€ ê°™ì€ ìºì‹œ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆê² ì§€ë§Œ, ì„œë“œíŒŒí‹°ì— ëŒ€í•œ ì¢…ì†ì„±ì´ ë†’ì•„ì§€ê³  ìì¹« ë¶ˆí•„ìš”í•œ ë¹„ìš©(ëˆ) ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤ëŠ” ë¬¸ì œì ì´ ìˆë‹¤. ì™¸ë¶€ ì„œë“œíŒŒí‹° êµ¬í˜„ì²´ë¥¼ ì„œë¹„ìŠ¤ì— ë„ì…í•˜ê³  í‹±í‹± ë¶™ì—¬ëŒ€ë©´ ê¸°ëŠ¥ êµ¬í˜„ë„ ë¹ ë¥´ê²Œ ëë‚˜ê³  í¸ë¦¬í•  ê²ƒì´ë‹¤. í•˜ì§€ë§Œ ì´ ë°©ë²•ì€ ì¢‹ì§€ ì•Šì€ ê°œë°œì ì—­ëŸ‰ì´ì ì˜ëª»ëœ ê°œì„  ë°©í–¥ì´ë¼ ìƒê°í•œë‹¤. ê²Œë‹¤ê°€ TTL ê¸°ëŠ¥ í•˜ë‚˜ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ ì™¸ë¶€ ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ëŠ” ê²ƒë³´ë‹¤, í˜„ì¬ ì£¼ì–´ì§„ ìì›ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì„ ê³„ì† ê³ ë¯¼í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•˜ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤.

> ğŸ’¡ í•„ìê°€ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ” ê°œë°œì ì—­ëŸ‰ ì¤‘ í•˜ë‚˜ëŠ”, ë¶ˆí•„ìš”í•œ ë¹„ìš©ì„ ì—†ì• ê³ (ë¹„ìš© ì ˆì•½) ì™¸ë¶€ ì„œë“œíŒŒí‹° êµ¬í˜„ì²´ì— ëŒ€í•œ ì¢…ì†ì„±ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ì£¼ì–´ì§„ ìƒí™©ê³¼ í•œì •ì ì¸ ìì›ìœ¼ë¡œ ìµœëŒ€í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê²ƒì´ ê°œë°œìì˜ ì¤‘ìš”í•œ ì—­ëŸ‰ì´ë¼ê³  ìƒê°í•œë‹¤.


## ConcurrentMapCache ì„ ìƒì†í•œ ìºì‹œ êµ¬í˜„ì²´ êµ¬í˜„

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `ConcurrentMapCache` ì„ ìƒì†í•œ êµ¬í˜„ì²´ `ExternalSimilarTripCache` ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ë‚´ì–´ TTL ì„ êµ¬í˜„í•˜ë„ë¡ í–ˆë‹¤. `ExternalSimilarTripCache` ëŠ” `put()` ì„ í†µí•´ ë°ì´í„°ë¥¼ ìºì‹œì— ë“±ë¡í•˜ê³ , `lookup()` ì„ í†µí•´ ìºì‹œì— ë‹´ê²¨ìˆëŠ” ë°ì´í„°ë¥¼ êº¼ë‚´ì˜¨ë‹¤. ë” ìì„¸íˆ ì‚´í´ë³´ì.

~~~java
public class ExternalSimilarTripCache extends ConcurrentMapCache {
    private final Map<Object, LocalDateTime> tripCache = new ConcurrentHashMap<>();
    private final long expiresDatePoint;

    public ExternalSimilarTripCache(final String name, final long expiresDatePoint) {
        super(name);
        this.expiresDatePoint = expiresDatePoint;
    }

    @Override
    protected Object lookup(final Object key) {
        final LocalDateTime expiredDate = tripCache.get(key);
        if(Objects.isNull(expiredDate) || isCacheValid(expiredDate)) {
            return super.lookup(key);
        }

        tripCache.remove(key);
        super.evict(key);
        return null;
    }

    @Override
    public void put(final Object key, final Object value) {
        final LocalDateTime expiredDate = LocalDateTime.now().plusSeconds(expiresDatePoint);
        tripCache.put(key, expiredDate);

        super.put(key, value);
    }

    private boolean isCacheValid(final LocalDateTime expiredDate) {
        return LocalDateTime.now().isBefore(expiredDate);
    }
}
~~~

ìš°ì„  `put()` ì„ ì˜¤ë²„ë¼ì´ë“œ í–ˆë‹¤. `put()` ì€ ìºì‹œì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì‹œì ì— `@Cacheable` ì„ í†µí•´ ì§€ì •ëœ key ê°’ì„ key ë¡œ í•˜ê³ , value ë¥¼ í˜„ì¬ì‹œê°„(=  LocalDateTime.now( )) ì— ì§€ì •ëœ ë§Œë£Œì‹œê°„ë§Œí¼ì„ ë”í•œ ë‚ ì§œë¡œ í•˜ì—¬ ì €ì¥í•œë‹¤. ìš°ë¦¬ íŒ€ì˜ ê²½ìš° í˜„ì¬ì‹œê°„ìœ¼ë¡œë¶€í„° 2ì‹œê°„ ì´í›„ë¥¼ ë§Œë£Œ ë‚ ì§œë¡œ í•˜ëŠ” ì •ì±…ì— ê¸°ë°˜í•˜ì—¬ `expiredDatePoint` ë³€ìˆ˜ì— ê°’ì„ ì£¼ì…í•˜ë„ë¡ í–ˆë‹¤.

~~~java
@Override
public void put(final Object key, final Object value) {
    final LocalDateTime expiredDate = LocalDateTime.now().plusSeconds(expiresDatePoint);
    tripCache.put(key, expiredDate);

    super.put(key, value);
}
~~~

`lookup()` ì€ ìºì‹œ ë©”ëª¨ë¦¬ë‚´ì— ë‹´ê¸´ ë°ì´í„° ì¤‘ ì›í•˜ëŠ” ë°ì´í„°ë¥¼ key ê°’ì„ ì°¾ì•„ë‚´ëŠ” ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆë‹¤. ì›í•˜ëŠ” ë°ì´í„°ê°€ ìºì‹œë‚´ì— ì¡´ì¬í•œë‹¤ë©´, ì¦‰ **ìºì‹œ íˆíŠ¸(Cache Hit)** ë¼ë©´ ìºì‹±ëœ í•´ë‹¹ ë°ì´í„°ë¥¼ ë¦¬í„´í•œë‹¤. ë°˜ëŒ€ë¡œ **ìºì‹œ ë¯¸ìŠ¤(Cache Miss)** ë¼ë©´ `null` ì„ ë¦¬í„´í•œë‹¤.

ì´ëŸ¬í•œ ê¸°ëŠ¥ì„ ê°€ì§„ `lookup()` ì„ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬, ìš”ì²­í•œ ë°ì´í„°ê°€ ë§Œë£Œë˜ì—ˆë‹¤ë©´ `null` ì„ ë¦¬í„´í•˜ê³  í•´ë‹¹ ë°ì´í„°ë¥¼ ìºì‹œì—ì„œ ì œê±°í•œë‹¤.

~~~java
@Override
protected Object lookup(final Object key) {
    final LocalDateTime expiredDate = tripCache.get(key);
    if(Objects.isNull(expiredDate) || isCacheValid(expiredDate)) {
        return super.lookup(key);
    }

    tripCache.remove(key);
    super.evict(key);
    return null;
}
~~~

## ìºì‹œ êµ¬í˜„ì²´ ë“±ë¡

ì´ë ‡ê²Œ êµ¬í˜„í•œ `ExternalSimilarTripCache` ìºì‹œ êµ¬í˜„ì²´ë¥¼ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ë„ë¡ ë“±ë¡í•´ì£¼ë„ë¡ í•œë‹¤. `@EnableCaching` ì„ ëª…ì‹œí•˜ê³ , `SimpleCacheManager` ì„ í†µí•´ ë§Œë“  ì¼€ì‹œë¥¼ ë“±ë¡í•´ì£¼ì. 

`SimpleCacheManager` ëŠ” ì‚¬ìš©í•  ìºì‹œë¥¼ ì§ì ‘ ë“±ë¡í•´ì¤„ ë•Œ ì‚¬ìš©í•˜ëŠ” ìºì‹œ ë§¤ë‹ˆì €ì´ë‹¤. ë³´í†µ ìºì‹œ í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ë§Œë“œëŠ” ê²½ìš° ì‚¬ìš©í•˜ê¸°ì— ì ë‹¹í•˜ë‹¤. ë˜í•œ `LIFE_CYCLE` ì„ í†µí•´ ì•ì„  ë§Œë£Œì‹œê°„ì„ ì§€ì •í•´ì¤¬ëŠ”ë°, ì„¤ëª…í–ˆë“¯ì´ ìš°ë¦¬ íŒ€ì˜ ê²½ìš° 2ì‹œê°„ì„ ë§Œë£Œê¸°ê°„ìœ¼ë¡œ ì§€ì •í–ˆë‹¤.

~~~java
@Configuration
@EnableCaching
public class CacheConfig {
    public static final String EXTERNAL_SIMILAR_TRIP_CACHE = "SIMILAR_TRIP_CACHE";
    private static final long LIFE_CYCLE = 60 * 60 * 2;

    @Bean
    public CacheManager cacheManager() {
        SimpleCacheManager simpleCacheManager = new SimpleCacheManager();
        simpleCacheManager.setCaches(List.of(new ExternalSimilarTripCache(EXTERNAL_SIMILAR_TRIP_CACHE, LIFE_CYCLE)));
        return simpleCacheManager;
    }

    // ...
}
~~~

## ìºì‹œ ë§Œë£Œì‹œê°„ì„ ì–´ëŠì •ë„ë¡œ í•´ì•¼í• ê¹Œ?

ì •ë§ ë§ì€ ê³ ë¯¼ì´ ìˆì—ˆë˜ ìš”ì†Œì´ë‹¤. ìºì‹±ëœ ë°ì´í„°ì˜ ë§Œë£Œê¸°ê°„ì„ ì–´ëŠì •ë„ë¡œ í•´ì•¼ ì ë‹¹í• ê¹Œ? ê²°ë¡ ì ìœ¼ë¡œ ìš°ë¦¬ íŒ€ì€ ì•ì„œ ê³„ì† ì„¤ëª…í–ˆë“¯ì´ 2ì‹œê°„ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤. ìš°ì„  AI ì„œë¹™ ì„œë²„ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì™€ ê°™ì´ ì™„ë²½íˆ ì œì–´í•  ìˆ˜ ìˆëŠ” ìš”ì†Œê°€ ì•„ë‹ˆë‹¤. ë”°ë¼ì„œ ë¹„ìŠ·í•œ ì—¬í–‰ì§€ ì‘ë‹µ ê²°ê³¼ê°€ ì˜¬ë°”ë¥¸ì§€ì— ëŒ€í•´ ì•Œ ìˆ˜ ì—†ë‹¤.

ë”°ë¼ì„œ ìºì‹œ ë§Œë£Œê¸°ê°„ì„ ë„ˆë¬´ ê¸¸ê²Œ ì„¤ì •í•˜ë©´ ìœ ì €ê°€ ìì¹« ì˜ëª»ëœ ì„±í–¥ì˜ ë¹„ìŠ·í•œ ì—¬í–‰ì§€ë¥¼ ë³¼ ìˆ˜ë„ ìˆë‹¤. ê·¸ë ‡ë‹¤ê³  ë§Œë£Œê¸°ê°„ì„ ë„ˆë¬´ ì§§ê²Œ ì¡ìë‹ˆ ìºì‹œ ë¯¸ìŠ¤ê°€ ìì£¼ ë°œìƒí•´ì„œ ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆë‹¤. ë„ˆë¬´ ê¸¸ì§€ë„ ì•Šê³ , ë„ˆë¬´ ì§§ì§€ë„ ì•Šì€ ì ë‹¹í•œ ë§Œë£Œ ê¸°ê°„ì´ í•„ìš”í•˜ë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ AI ì•Œê³ ë¦¬ì¦˜ì„ ìˆ˜í–‰í–ˆì„ ë•Œ, ë§¤ìš° ë†’ì€ í™•ë¥ ë¡œ ì •í™•í•˜ê²Œ ë¹„ìŠ·í•œ ì„±í–¥ì˜ ì•Œê³ ë¦¬ì¦˜ì„ ì¶”ì²œí•´ì¤€ë‹¤. ë˜í•œ ì˜ ì„¤ê³„ëœ ì•Œê³ ë¦¬ì¦˜ ë•ë¶„ì—, í˜„ì¬ ì—¬í–‰ì§€ì™€ ë¹„ìŠ·í•œ ì—¬í–‰ì§€ë¥¼ ì¶”ì²œë°›ì€ ê²°ê³¼ëŠ” í•­ìƒ ê°™ì€ ë°ì´í„°ì…‹ì„ ì œê³µë°›ëŠ”ë‹¤. ê±°ì˜ ë³€í•˜ì§€ ì•ŠëŠ” íŠ¹ì„± ë•Œë¬¸ì— ìºì‹±ì„ ë„ì…í•œ ê²ƒì´ê¸°ë„ í•˜ë‹¤. ì´ëŸ° ì ì„ ê³ ë ¤í–ˆì„ ë–„ ìºì‹œ ë§Œë£Œ ê¸°ê°„ì„ ë„ˆë¬´ ì§§ê²Œ ì„¤ì •í•˜ë©´ ìºì‹œ ë¯¸ìŠ¤ê°€ ìì£¼ ë°œìƒí•˜ê³  ì„±ëŠ¥ì´ ì €í•˜ë  ê²ƒì´ë‹¤. ë”°ë¼ì„œ ì„ì˜ë¡œ 2ì‹œê°„ ì •ë„ì˜ ë§Œë£Œ ê¸°ê°„ì´ ì í•©í•˜ë‹¤ê³  íŒë‹¨í–ˆë‹¤. ë‹¤ë§Œ, ìš°ë¦¬ ì„œë¹„ìŠ¤ë¥¼ ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸ ë° ìš´ì˜í•˜ë©´ì„œ ì´ ë§Œë£Œ ì •ì±…ì´ ìµœì„ ì¼ì§€ëŠ” ë” ë³´ê°•í•´ì•¼í•  ì ì´ë¼ê³  ìƒê°í•œë‹¤.

## ë§¤ì¼ ìì • ìŠ¤ìºì¥´ë§ì„ í†µí•´ ë§Œë£Œëœ ë°ì´í„° ìºì‹œì—ì„œ ì œê±°

ê·¸ëŸ°ë° ë¬¸ì œì ì´ ì•„ì§ ë‚¨ì•„ìˆë‹¤. ìºì‹±ëœ ë°ì´í„° ì¤‘ì— ë§Œë£Œê¸°ê°„ì´ ì§€ë‚¬ìŒì—ë„ í•´ë‹¹ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ê¸° ëŒ€í•œ ì¬ìš”ì²­ì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì˜ì›ì— ìºì‹œ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ìˆë‹¤ëŠ” ì ì´ë‹¤. ë”°ë¼ì„œ í•´ë‹¹ ë°ì´í„°ëŠ” ìºì‹œ ë©”ëª¨ë¦¬ì—ì„œ ì˜ì›íˆ ë¶ˆí•„ìš”íˆê²Œ ê³µê°„ì„ ì ìœ í•˜ê³  ìˆê²Œëœë‹¤. ì´ë¥¼ ìœ„í•´ ìŠ¤í”„ë§ì—ì„œ ì œê³µí•˜ëŠ” `@Scheduled` ë¡œ ìŠ¤ìºì¥´ë§í•˜ì—¬, ë§¤ì¼ ìì • ë§Œë£Œëœ ìºì‹œë¥¼ ì§€ìš°ë„ë¡ êµ¬í˜„í–ˆë‹¤.

`evictAllTrips()` ì„ ìˆ˜í–‰í•˜ì—¬ ìœ íš¨í•˜ì§€ ì•Šì€ ìºì‹œ ë°ì´í„°, ì¦‰ ë§Œë£Œëœ ë°ì´í„°ë¥¼ ì œê±°í•˜ë„ë¡ í•œë‹¤.

~~~java
public class ExternalSimilarTripCache extends ConcurrentMapCache {
    private final Map<Object, LocalDateTime> tripCache = new ConcurrentHashMap<>();
    private final long expiresDatePoint;

    public ExternalSimilarTripCache(final String name, final long expiresDatePoint) {
        super(name);
        this.expiresDatePoint = expiresDatePoint;
    }

    // ...

    public void evictAllTrips() {
        ConcurrentMap<Object, Object> currentCache = getNativeCache();

        currentCache.keySet()
                .stream()
                .filter(key -> !isCacheValid(tripCache.get(key)))
                .forEach(super::evict);
    }
}
~~~

`@Scheduled` ë¡œ ë§¤ì¼ ìì •ë§ˆë‹¤ `evictAllTrips()` ì„ ì‹¤í–‰í•˜ì—¬ ë§Œë£Œëœ ëª¨ë“  ìºì‹œë¥¼ ì œê±°í•˜ë„ë¡ í•œë‹¤.

~~~java
@Configuration
@EnableCaching
@EnableScheduling
public class CacheConfig {
    public static final String EXTERNAL_SIMILAR_TRIP_CACHE = "SIMILAR_TRIP_CACHE";
    private static final long LIFE_CYCLE = 60 * 60 * 2;

    // ...

    @Scheduled(cron = "0 0 0 * * *")
    private void evict() {
        ExternalSimilarTripCache externalSimilarTripCache = (ExternalSimilarTripCache)  cacheManager().getCache(EXTERNAL_SIMILAR_TRIP_CACHE);
        externalSimilarTripCache.evictAllTrips();
    }
}
~~~

ìµœì í™”ë¥¼ ì§„í–‰í•˜ê¸°ì „ì—ëŠ” ë¹„ìŠ·í•œ ì—¬í–‰ì§€ ì¡°íšŒ API ì‹¤í–‰ì‹œ í‰ê· ì ìœ¼ë¡œ 580ms ê°€ëŸ‰ì˜ ì‹¤í–‰ì‹œê°„ì´ ê±¸ë ¸ë‹¤. ìš´ì´ì¢‹ê²Œ ê°€ì¥ ë¹ ë¥¸ ê²½ìš°ëŠ” ì•½ 430ms ê°€ëŸ‰ì˜ ì„±ëŠ¥ì´ ë³´ì´ê¸°ë„ í–ˆë‹¤. ë°˜ë©´ ë¡œì»¬ ìºì‹œë¥¼ ë„ì…í•œ ì´í›„ í‰ê·  ì‘ë‹µì‹œê°„ì´ ì•½ 120ms ê°€ëŸ‰ìœ¼ë¡œ ê°ì†Œí–ˆë‹¤. **ìºì‹± ì ìš©ì „ ëŒ€ë¹„ ì•½ 4.8ë°° ì„±ëŠ¥ì´ ê°œì„ ë˜ì—ˆë‹¤** ğŸ˜

## ì°¸ê³ 

- https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentHashMap.html
- https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/cache/concurrent/ConcurrentMapCache.html
- https://jiwondev.tistory.com/282
- https://hudi.blog/optimizing-external-calendar-api-calling-with-spring-local-cache/
- https://loosie.tistory.com/806
- https://bcp0109.tistory.com/385
- https://velog.io/@yyong3519/ìŠ¤í”„ë§ë¶€íŠ¸-Cache-ì‚¬ìš©-4
- https://parkmuhyeun.github.io/woowacourse/2023-09-09-Concurrent-Hashmap/